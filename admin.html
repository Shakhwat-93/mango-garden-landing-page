<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল | ম্যাংগো গার্ডেন</title>
      <link rel="icon" type="image/x-icon" href="assests/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #FFF8E7; 
            color: #3E2723; 
        }
        .hidden { display: none; }
        .bg-gur { background-color: #4A2C2A; }
        .text-gur { color: #4A2C2A; }
        .bg-mango { background-color: #F59E0B; }
        .text-mango { color: #F59E0B; }
        
        /* Status Colors */
        .status-pending { background-color: #FEF3C7; color: #D97706; border: 1px solid #FCD34D; }
        .status-complete { background-color: #D1FAE5; color: #059669; border: 1px solid #6EE7B7; }
        .status-failed { background-color: #FEE2E2; color: #DC2626; border: 1px solid #FCA5A5; }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4A2C2A;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#FFF8E7]">

    <div id="login-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 border-t-4 border-gur">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-100 text-gur rounded-full flex items-center justify-center text-2xl mx-auto mb-2">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-[#3E2723]">অ্যাডমিন লগইন</h2>
                <p class="text-sm text-[#5D4037]">ম্যাংগো গার্ডেন ড্যাশবোর্ড</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-[#5D4037] text-sm font-bold mb-2">ইউজারনেম</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A2C2A]">
                </div>
                <div class="mb-6">
                    <label class="block text-[#5D4037] text-sm font-bold mb-2">পাসওয়ার্ড</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A2C2A]">
                </div>
                <button type="submit" class="w-full bg-gur text-white font-bold py-2 px-4 rounded-lg hover:bg-[#3E2723] transition shadow-md">
                    লগইন করুন
                </button>
                <p id="error-msg" class="text-red-500 text-xs mt-3 text-center hidden">ভুল ইউজারনেম বা পাসওয়ার্ড!</p>
            </form>
        </div>
    </div>

    <div id="dashboard-section" class="hidden min-h-screen flex flex-col">
        <nav class="bg-gur text-white p-4 shadow-md flex justify-between items-center border-b border-[#3E2723]">
            <div class="flex items-center gap-3">
                <i class="fas fa-tree text-xl text-mango"></i>
                <h1 class="text-xl font-bold hidden sm:block">ম্যাংগো গার্ডেন অ্যাডমিন</h1>
            </div>
            <div class="flex items-center gap-3">
                <span id="last-updated" class="text-xs text-gray-300 hidden sm:block"></span>
                <button onclick="logout()" class="bg-[#3E2723] hover:bg-black px-4 py-1.5 rounded-lg text-sm font-bold border border-orange-900/50 transition">
                    <i class="fas fa-sign-out-alt"></i> লগআউট
                </button>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white shadow-md hidden md:block border-r border-orange-100">
                <div class="p-6">
                    <ul class="space-y-4">
                        <li class="flex items-center gap-3 text-gur font-bold bg-orange-100 p-3 rounded-lg cursor-pointer border-l-4 border-gur">
                            <i class="fas fa-shopping-bag"></i> লাইভ অর্ডার
                        </li>
                        <li class="flex items-center gap-3 text-[#5D4037] p-3 hover:bg-orange-50 rounded-lg cursor-pointer transition">
                            <a href="https://docs.google.com/spreadsheets" target="_blank" class="flex items-center gap-3 w-full">
                                <i class="fas fa-table"></i> গুগল শিট দেখুন
                            </a>
                        </li>
                    </ul>
                </div>
            </aside>

            <main class="flex-1 p-4 md:p-6 overflow-y-auto bg-[#FFF8E7]">
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gur flex items-center justify-between">
                            <div>
                                <p class="text-[#5D4037] text-sm">মোট অর্ডার</p>
                                <h3 class="text-2xl font-bold text-[#3E2723]" id="total-orders">loading...</h3>
                            </div>
                            <i class="fas fa-shopping-cart text-3xl text-orange-200"></i>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-600 flex items-center justify-between">
                            <div>
                                <p class="text-[#5D4037] text-sm">মোট বিক্রি</p>
                                <h3 class="text-2xl font-bold text-[#3E2723]" id="total-revenue">loading...</h3>
                            </div>
                            <i class="fas fa-bangladeshi-taka-sign text-3xl text-green-200"></i>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex items-center justify-between">
                            <div>
                                <p class="text-[#5D4037] text-sm">পেন্ডিং অর্ডার</p>
                                <h3 class="text-2xl font-bold text-blue-600" id="pending-count">0</h3>
                            </div>
                            <i class="fas fa-clock text-3xl text-blue-200"></i>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 flex flex-col items-center justify-center">
                        <h4 class="text-sm font-bold text-[#5D4037] mb-2">অর্ডার স্ট্যাটাস চার্ট</h4>
                        <div class="w-full h-32 relative">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-orange-100">
                    <div class="p-4 border-b border-orange-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-orange-50/30">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <h3 class="text-lg font-bold text-[#3E2723]">অর্ডার তালিকা</h3>
                            
                            <div class="relative">
                                <select id="filter-status" onchange="filterTable()" class="appearance-none bg-white border border-orange-300 text-[#5D4037] py-1 pl-3 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gur cursor-pointer font-semibold">
                                    <option value="all">সব দেখুন (All)</option>
                                    <option value="pending">অপেক্ষমান (Pending)</option>
                                    <option value="complete">সম্পন্ন (Complete)</option>
                                    <option value="failed">বাতিল (Failed)</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-filter text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="fetchData()" class="flex items-center gap-2 bg-white border border-gray-300 px-3 py-1.5 rounded-md text-sm text-[#5D4037] hover:bg-gur hover:text-white hover:border-gur transition shadow-sm group">
                            <i id="refresh-icon" class="fas fa-sync-alt group-hover:rotate-180 transition duration-500"></i> রিফ্রেশ
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[900px]">
                            <thead>
                                <tr class="bg-orange-50 text-[#5D4037] text-sm uppercase">
                                    <th class="p-4">তারিখ</th>
                                    <th class="p-4">আইডি</th>
                                    <th class="p-4">কাস্টমার</th>
                                    <th class="p-4">ঠিকানা</th>
                                    <th class="p-4">পণ্য</th>
                                    <th class="p-4">বিল</th>
                                    <th class="p-4 text-center">স্ট্যাটাস</th> <th class="p-4 text-center">অ্যাকশন</th>
                                </tr>
                            </thead>
                            <tbody id="order-table-body" class="text-sm text-gray-700 divide-y divide-orange-100">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-data-msg" class="p-8 text-center text-gray-400 hidden">
                        কোনো অর্ডার পাওয়া যায়নি।
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // API Config
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxqrBdrBYGcL7NqZlqS-cgAksCNh3XEyi3A2_TGP_TarlRa2gDX1w9L1e78QxD-LS_H8Q/exec"; 
        const ADMIN_USER = "mangogarden@gmail.com";
        const ADMIN_PASS = "01798251691";

        let allOrders = []; // Store fetched orders globally
        let myChart = null; // Chart instance

        // --- Auth Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('is_admin_logged_in');
            if (isLoggedIn === 'true') {
                showDashboard();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
            }
        });

        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if(user === ADMIN_USER && pass === ADMIN_PASS) {
                localStorage.setItem('is_admin_logged_in', 'true');
                showDashboard();
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('is_admin_logged_in');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            fetchData();
        }

        // --- Data Fetching ---
        function fetchData() {
            const tableBody = document.getElementById('order-table-body');
            const refreshIcon = document.getElementById('refresh-icon');
            
            refreshIcon.classList.add('fa-spin');
            tableBody.innerHTML = `<tr><td colspan="8" class="p-10 text-center text-gray-500"><div class="flex flex-col items-center justify-center gap-2"><div class="spinner"></div> লোড হচ্ছে...</div></td></tr>`;

            fetch(SHEET_API_URL)
            .then(response => response.json())
            .then(data => {
                // ** Mock Status Simulation ** // যেহেতু API তে স্ট্যাটাস নেই, আমরা ডেমোর জন্য প্রত্যেক অর্ডারে 'Pending' বা র‍্যান্ডম স্ট্যাটাস বসাবো
                allOrders = data.map(order => ({
                    ...order,
                    status: localStorage.getItem(`status_${order.id}`) || 'pending' // লোকাল স্টোরেজ থেকে স্ট্যাটাস চেক করবে, না থাকলে 'pending'
                })).reverse();

                renderTable(allOrders);
                updateDashboardMetrics(allOrders);
                updateChart(allOrders);
                updateLastUpdatedTime();
            })
            .catch(error => {
                console.error('Error:', error);
                tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-red-500">ডাটা লোড সমস্যা।</td></tr>`;
            })
            .finally(() => {
                refreshIcon.classList.remove('fa-spin');
            });
        }

        // --- Render Table ---
        function renderTable(orders) {
            const tableBody = document.getElementById('order-table-body');
            const noDataMsg = document.getElementById('no-data-msg');

            tableBody.innerHTML = '';

            if (orders.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            orders.forEach(order => {
                let cleanPhone = String(order.phone).replace(/'/g, '');
                let dateDisplay = order.date ? order.date.split(' ')[0] : '-';
                
                // Determine Class based on status
                let statusClass = 'status-pending';
                if(order.status === 'complete') statusClass = 'status-complete';
                if(order.status === 'failed') statusClass = 'status-failed';

                const row = `
                    <tr class="hover:bg-orange-50 transition border-b border-orange-50">
                        <td class="p-4 text-xs text-gray-500">${dateDisplay}</td>
                        <td class="p-4 font-mono text-xs text-gur font-bold">#${order.id}</td>
                        <td class="p-4 font-bold text-[#3E2723]">${order.name}</td>
                        <td class="p-4 max-w-xs truncate text-[#5D4037] text-xs" title="${order.address}">${order.address}</td>
                        <td class="p-4 max-w-xs truncate text-xs text-gray-500" title="${order.items}">${order.items}</td>
                        <td class="p-4 font-bold text-green-700">${order.total}</td>
                        
                        <td class="p-4 text-center">
                            <select onchange="changeStatus('${order.id}', this.value)" 
                                class="text-xs font-bold py-1 px-2 rounded cursor-pointer outline-none ${statusClass}">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="complete" ${order.status === 'complete' ? 'selected' : ''}>Complete</option>
                                <option value="failed" ${order.status === 'failed' ? 'selected' : ''}>Failed</option>
                            </select>
                        </td>

                        <td class="p-4 text-center">
                            <a href="tel:${cleanPhone}" class="bg-green-100 text-green-700 hover:bg-green-600 hover:text-white px-3 py-1 rounded-full text-xs font-bold transition inline-flex items-center">
                                <i class="fas fa-phone-alt mr-1"></i> কল
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- Logic: Change Status ---
        function changeStatus(id, newStatus) {
            // Update Local Data
            const orderIndex = allOrders.findIndex(o => o.id == id);
            if(orderIndex > -1) {
                allOrders[orderIndex].status = newStatus;
                // Save to Local Storage so it persists on refresh (Browser only)
                localStorage.setItem(`status_${id}`, newStatus);
                
                // Re-render UI
                filterTable(); // Re-apply filter if active
                updateDashboardMetrics(allOrders);
                updateChart(allOrders);
            }
        }

        // --- Logic: Filter Table ---
        function filterTable() {
            const filterValue = document.getElementById('filter-status').value;
            
            if (filterValue === 'all') {
                renderTable(allOrders);
            } else {
                const filtered = allOrders.filter(order => order.status === filterValue);
                renderTable(filtered);
            }
        }

        // --- Metrics & Chart ---
        function updateDashboardMetrics(orders) {
            document.getElementById('total-orders').innerText = orders.length;
            
            let totalRev = 0;
            let pendingCount = 0;
            
            orders.forEach(order => {
                let priceStr = String(order.total).replace(/[^\d.]/g, '');
                let amount = parseFloat(priceStr) || 0;
                totalRev += amount;
                
                if(order.status === 'pending') pendingCount++;
            });
            
            document.getElementById('total-revenue').innerText = '৳ ' + totalRev.toLocaleString();
            document.getElementById('pending-count').innerText = pendingCount;
        }

        function updateChart(orders) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            let pending = orders.filter(o => o.status === 'pending').length;
            let complete = orders.filter(o => o.status === 'complete').length;
            let failed = orders.filter(o => o.status === 'failed').length;

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Complete', 'Failed'],
                    datasets: [{
                        data: [pending, complete, failed],
                        backgroundColor: [
                            '#FCD34D', // Yellow for Pending
                            '#34D399', // Green for Complete
                            '#F87171'  // Red for Failed
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false 
                        }
                    }
                }
            });
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('last-updated').innerText = `Last updated: ${now.toLocaleTimeString()}`;
        }
    </script>
</body>
</html>